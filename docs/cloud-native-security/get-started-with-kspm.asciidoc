[[get-started-with-kspm]]
== Get started with KSPM
This page explains how to configure the Kubernetes Security Posture Management integration.

The instructions differ depending on whether you're installing on EKS or on unmanaged clusters.

1. Install on EKS-managed clusters:
  * <<kspm-setup-eks,Configure the KSPM integration>>
  * <<kspm-setup-eks-step-2,Authenticate to AWS>>
  * <<kspm-setup-eks-step-3,>>


2. Install on unmanaged clusters:
  * <<kspm-setup-unmanaged,Configure the KSPM integration>>
  * <<kspm-setup-unmanaged-step-2,Modify and deploy the DaemonSet manifest to your clusters>>

[discrete]
[[kspm-setup-eks]]
== Set up KSPM for Amazon EKS clusters

1. Go to *Dashboards -> Cloud Posture*.
2. Click *Add a KSPM integration*.
3. Read the integration's readme to understand how it works. Then, click *Add Kubernetes Security Posture Management*.
4. Name your integration. Use a name that matches the purpose or team of the cluster(s) you want to monitor, for example, `IT-dev-k8s-clusters`.
5. Select *EKS* from the *Kubernetes Deployment* menu. A new section for AWS credentials will appear.

[[kspm-setup-eks-step-2]]

To get the necessary credentials, follow Amazon's instructions to https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html[create an IAM user], and define its permissions using the JSON permissions policy below.

IMPORTANT: You must select "Programmatic access" when creating the IAM user.

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ecr:GetRegistryPolicy",
                "eks:ListTagsForResource",
                "elasticloadbalancing:DescribeTags",
                "ecr-public:DescribeRegistries",
                "ecr:DescribeRegistry",
                "elasticloadbalancing:DescribeLoadBalancerPolicyTypes",
                "ecr:ListImages",
                "ecr-public:GetRepositoryPolicy",
                "elasticloadbalancing:DescribeLoadBalancerAttributes",
                "elasticloadbalancing:DescribeLoadBalancers",
                "ecr-public:DescribeRepositories",
                "eks:DescribeNodegroup",
                "ecr:DescribeImages",
                "elasticloadbalancing:DescribeLoadBalancerPolicies",
                "ecr:DescribeRepositories",
                "eks:DescribeCluster",
                "eks:ListClusters",
                "elasticloadbalancing:DescribeInstanceHealth",
                "ecr:GetRepositoryPolicy"
            ],
            "Resource": "*"
        }
    ]
}
```

IMPORTANT: If you choose to use the AWS Shared credential file to provide credentials, make sure the associated role has the permissions listed above.

* If you want to monitor Kubernetes clusters that aren’t yet enrolled in fleet, select *New Hosts* under “where to add this integration”.
* Name the {agent} policy. Use a name that matches the purpose or team of the cluster(s) you want to monitor, for example, `IT-dev-k8s-clusters`.
* Click *Save and continue*, then *Add agent to your hosts*. The *Add agent* wizard appears and provides a DaemonSet manifest `.yaml` file with pre-populated configuration information, such as the `Fleet ID` and `Fleet URL`.

[[kspm-setup-eks-step-3]]
The *Add agent* wizard helps you deploy a DaemonSet on the Kubernetes clusters you wish to monitor. To do this, for each cluster:

1. Download the manifest and make any necessary revisions to its configuration to suit the needs of your environment.
2. Apply the manifest using the `kubectl apply -f` command. For example: `kubectl apply -f elastic-agent-managed-kubernetes.yaml`

After a few minutes, a message confirming the {agent} enrollment appears, followed by a message confirming that data is incoming. You can then click *View assets* to see where the newly-collected configuration information appears throughout {kib}, including the <<findings-page,Findings page>> and the <<cloud-posture-dashboard, Cloud Posture dashboard>>.
After applying the manifest, it will take about 10 minutes for the posture dashboard and findings page to display data.



[discrete]
[[kspm-setup-unmanaged]]
== Set up KSPM for unmanaged Kubernetes clusters

To install the integration:

1. Go to *Dashboards -> Cloud Posture*.
2. Click *Add a KSPM integration*.
3. Read the integration's readme to understand how it works. Then, click *Add Kubernetes Security Posture Management*.
4. Name your integration. Use a name that matches the purpose or team of the cluster(s) you want to monitor, for example, `IT-dev-k8s-clusters`.
5. Select *Unmanaged Kubernetes* from the *Kubernetes Deployment* menu.
6. If you want to monitor Kubernetes clusters that aren’t yet enrolled in fleet, select *New Hosts* under “where to add this integration”.
7. Select the {agent} policy where you want to add the integration.
8. Click *Save and continue*, then *Add agent to your hosts*. The *Add agent* wizard appears and provides a DaemonSet manifest `.yaml` file with pre-populated configuration information, such as the `Fleet ID` and `Fleet URL`.

image::images/kspm-add-agent-wizard.png[The KSPM integration's Add agent wizard]

[[kspm-setup-unmanaged-step-2]]
The *Add agent* wizard helps you deploy a DaemonSet on the Kubernetes clusters you wish to monitor. To do this, for each cluster:

1. Download the manifest and make any necessary revisions to its configuration to suit the needs of your environment.
2. Apply the manifest using the `kubectl apply -f` command. For example: `kubectl apply -f elastic-agent-managed-kubernetes.yaml`

After a few minutes, an “Agent enrollment confirmed” message will appear, followed by “Incoming data confirmed." You can then click *View assets* to see where the newly-collected configuration information appears throughout {kib}, including the <<findings-page,Findings page>> and the <<cloud-posture-dashboard, Cloud Posture dashboard>>.
